<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Firebase Shared Counter</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getDatabase, ref, onValue, runTransaction, push } 
        from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

      // üîπ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDyFxHLRFtY7NoddH5WCs8M1Q3DCm06rcU",
        authDomain: "coolforsaljning.firebaseapp.com",
        databaseURL: "https://coolforsaljning-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "coolforsaljning",
        storageBucket: "coolforsaljning.firebasestorage.app",
        messagingSenderId: "347896271740",
        appId: "1:347896271740:web:eae95f1932f79535788af9"
      };

      // üîπ Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();
      const counterRef = ref(db, "counter");
      const logRef = ref(db, "log");

      // üîπ Sign in with Google
      window.signIn = () => {
        signInWithPopup(auth, provider).catch((error) => {
          console.error("Sign-in error:", error);
        });
      };

      // üîπ Sign out
      window.signOutUser = () => {
        signOut(auth);
      };

      // üîπ Track login state
      onAuthStateChanged(auth, (user) => {
        const status = document.getElementById("status");
        if (user) {
          status.textContent = `Signed in as: ${user.displayName} (${user.email})`;
        } else {
          status.textContent = "Not signed in";
        }
      });

      // üîπ Update counter live
      onValue(counterRef, (snapshot) => {
        const value = snapshot.val() ?? 0;
        document.getElementById("counter").textContent = value;
      });

      // üîπ Show live log updates (last 10 actions)
onValue(logRef, (snapshot) => {
  const logs = snapshot.val();
  const logList = document.getElementById("log");
  logList.innerHTML = ""; // clear old log

  if (logs) {
    const entries = Object.values(logs)
      .sort((a, b) => b.time - a.time) // newest first
      .slice(0, 10);                   // take only 10

    entries.forEach((entry) => {
      const li = document.createElement("li");
      const date = new Date(entry.time).toLocaleString();
      li.textContent = `${date}: ${entry.amount > 0 ? "+" : ""}${entry.amount} by ${entry.user || "Unknown"}`;
      logList.appendChild(li);
      });
      }
      });


      // üîπ Change counter (add/subtract) AND log it
      window.changeCounter = (amount) => {
        runTransaction(counterRef, (currentValue) => {
          return (currentValue || 0) + amount;
        });

        const user = auth.currentUser;
        push(logRef, {
          amount: amount,
          time: Date.now(),
          user: user ? user.displayName : "Anonymous",
          email: user ? user.email : null
        });
      };
    </script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
      h1 { font-size: 2rem; }
      button { margin: 5px; padding: 10px 20px; font-size: 1rem; }
      ul { list-style: none; padding: 0; }
    </style>
  </head>
  <body>
    <p id="status">Not signed in</p>
    <button onclick="signIn()">Sign in with Google</button>
    <button onclick="signOutUser()">Sign out</button>

    <h1>pengar: <span id="counter">0</span></h1>

    <div>
      <button onclick="changeCounter(10)">+10</button>
      <button onclick="changeCounter(20)">+20</button>
      <button onclick="changeCounter(30)">+30</button>
      <button onclick="changeCounter(40)">+40</button>
      <button onclick="changeCounter(50)">+50</button>
      <button onclick="changeCounter(60)">+60</button>
      <button onclick="changeCounter(70)">+70</button>
      <button onclick="changeCounter(80)">+80</button>
      <button onclick="changeCounter(90)">+90</button>
      <button onclick="changeCounter(100)">+100</button>
    </div>

    <p>(om ni s√§ljer n√•got, s√• l√§gg till hur mycket ni s√•lde f√∂r liksom)</p>

    <div>
      <button onclick="changeCounter(-10)">-10</button>
      <button onclick="changeCounter(-20)">-20</button>
      <button onclick="changeCounter(-30)">-30</button>
      <button onclick="changeCounter(-40)">-40</button>
      <button onclick="changeCounter(-50)">-50</button>
      <button onclick="changeCounter(-60)">-60</button>
      <button onclick="changeCounter(-70)">-70</button>
      <button onclick="changeCounter(-80)">-80</button>
      <button onclick="changeCounter(-90)">-90</button>
      <button onclick="changeCounter(-100)">-100</button>
    </div>

    <div class="group">
      <h2>Action Log</h2>
      <ul id="log"></ul>
    </div>

    <img src="swish.png" alt="Swish QR">
  </body>
</html>

